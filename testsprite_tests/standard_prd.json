{
  "meta": {
    "project": "Next.js AI Content Generation Platform",
    "date": "2025-12-18",
    "prepared_by": "Generated by TestSprite"
  },
  "product_overview": "A web platform leveraging Next.js and Firebase to enable users to generate AI content via OpenRouter API integration, manage workspace pages and invitations, with robust authentication, streaming, and encryption support.",
  "core_goals": [
    "Enable reliable AI content generation with seamless API integration and error handling.",
    "Support real-time streaming of AI-generated content without connection drops or timeouts.",
    "Provide secure and accurate user and page management with strict permission controls.",
    "Maintain data integrity and security through Firebase Firestore security rules and encrypted API key management.",
    "Ensure robust user authentication and authorization mechanisms to protect user data and API access."
  ],
  "key_features": [
    "AI Generation API supporting both regular and legacy slash commands with error and key handling.",
    "AI Stream API for delivering AI-generated content in chunked streaming form to the client.",
    "Pages API for creating, reading, updating, and deleting user pages with strict access control.",
    "Invitations API for sending and accepting workspace invitations with proper database state updates.",
    "Encrypted storage and retrieval of user-specific OpenRouter API keys with fallback to environment variables.",
    "Robust Firestore security rules preventing unauthorized data reads and writes, enforcing user-specific access.",
    "Authentication logic validating tokens and ensuring invalid tokens prompt reauthentication.",
    "Automatic handling of creation and update timestamps using server time.",
    "Soft or full deletion of page data including hierarchical blocks to avoid data remnants."
  ],
  "user_flow_summary": [
    "User makes a POST request to /api/ai with necessary prompts and a valid userId; system validates userId, retrieves and decrypts API key, calls OpenRouter API, and returns generated content or appropriate error codes.",
    "User connects to /api/ai/stream endpoint to receive AI content in streaming mode ensuring no disconnects and timely delivery without timeouts.",
    "User interacts with pages endpoint to manage pages; system verifies ownership and permissions before allowing access or modifications.",
    "Workspace invitations are sent and accepted via Invitations API, triggering database state changes to reflect new members and permissions.",
    "Authentication middleware verifies user tokens on API calls, fails quickly and prompts re-login on token expiration or invalidity.",
    "Security rules restrict data access so only authenticated users can read/write their own data and private subcollections remain inaccessible to others."
  ],
  "validation_criteria": [
    "POST /api/ai returns 400 error if userId is missing in the request.",
    "OpenRouter API key is correctly retrieved, decrypted from Firestore or fallback to environment variable if missing.",
    "Failures in OpenRouter API calls produce clear 500 errors shown to clients.",
    "Streaming API maintains continuous data flow without premature disconnection and respects timeout constraints imposed by the hosting environment.",
    "Page API endpoints reject unauthorized access to others' pages and successfully update data when permitted.",
    "Invitation API correctly updates Firestore state on send and accept events with no data inconsistencies.",
    "Firestore security rules prevent unauthenticated users from reading/writing data and restrict users to modify only their own data.",
    "API authentication tokens are validated for each request and expired tokens cause immediate failure prompting reauthentication.",
    "Encrypted API keys are correctly handled including special characters without corruption.",
    "Timestamps for createdAt and updatedAt are set using server time and checked for accuracy.",
    "Deletion of pages properly cascades or cleans associated subdocuments to avoid orphaned data or remnants."
  ],
  "code_summary": {
    "tech_stack": [
      "TypeScript",
      "Next.js",
      "React",
      "Firebase",
      "TailwindCSS",
      "Tiptap",
      "Yjs"
    ],
    "features": [
      {
        "name": "AI Generation API",
        "description": "API for generating AI content using OpenRouter, supports regular and legacy slash commands.",
        "files": [
          "src/app/api/ai/route.ts"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "paths": {
            "/api/ai": {
              "post": {
                "summary": "Generate AI content",
                "requestBody": {
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "properties": {
                          "messages": {
                            "type": "array"
                          },
                          "prompt": {
                            "type": "string"
                          },
                          "model": {
                            "type": "string"
                          },
                          "userId": {
                            "type": "string"
                          }
                        },
                        "required": [
                          "userId"
                        ]
                      }
                    }
                  }
                },
                "responses": {
                  "200": {
                    "description": "Successful response"
                  },
                  "400": {
                    "description": "Missing User ID"
                  },
                  "401": {
                    "description": "API Key missing"
                  },
                  "500": {
                    "description": "Internal Server Error"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "AI Stream API",
        "description": "API for streaming AI content generation.",
        "files": [
          "src/app/api/ai/stream/route.ts"
        ],
        "api_doc": {}
      },
      {
        "name": "Pages API",
        "description": "API for managing pages.",
        "files": [
          "src/app/api/pages/route.ts"
        ],
        "api_doc": {}
      },
      {
        "name": "Invitations API",
        "description": "API for managing workspace invitations.",
        "files": [
          "src/app/api/invitations/route.ts"
        ],
        "api_doc": {}
      }
    ]
  }
}
